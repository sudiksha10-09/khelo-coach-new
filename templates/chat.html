{% extends "base.html" %}

{% block content %}
<style>
/* --- LAYOUT --- */
.chat-container { height: calc(100vh - 120px); display: flex; background: #fff; border-radius: 8px; overflow: hidden; }
.contacts-sidebar { width: 280px; background: #f8fafc; border-right: 1px solid #e5e7eb; overflow-y: auto; }
.chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

/* --- CONTACT ITEM --- */
.contact-item {
  padding: 12px 14px;
  display:flex;
  gap:12px;
  align-items:center;
  border-bottom:1px solid #e5e7eb;
  text-decoration:none;
  color:inherit;
}
.contact-item:hover { background:#eef6ff; }
.contact-item.active { background:#dbeaff; border-left:4px solid #2563eb; }

.avatar {
  width:44px; height:44px; border-radius:10px; background:#2563eb; color:#fff;
  display:flex; align-items:center; justify-content:center; font-weight:700; overflow:hidden;
}

/* --- MESSAGES --- */
.messages-box {
  flex: 1;
  padding: 24px;
  padding-bottom: calc(var(--input-height, 80px) + 28px);
  overflow-y: auto;
  background: #f1f5f9;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
  scroll-behavior: smooth;
}

.message {
  max-width:72%;
  padding:12px 14px;
  border-radius:14px;
  font-size:0.95rem;
  word-break:break-word;
  box-shadow: 0 1px 0 rgba(15,23,42,0.03);
  position:relative;
}
.sent { align-self:flex-end; background:#2563eb; color:#fff; margin-left:30%; }
.received { align-self:flex-start; background:#e2e8f0; color:#0f172a; margin-right:30%; }

.msg-time {
  display:block;
  margin-top:6px;
  font-size:0.75rem;
  opacity:0.85;
  text-align:right;
  color: rgba(255,255,255,0.95);
}
.received .msg-time { color: rgba(15,23,42,0.6); }

/* --- TYPING --- */
#typingIndicator { display:none; margin-left:8px; font-size:0.9rem; color:#2563eb; }

/* --- INPUT --- */
.chat-input-area {
  --input-height: 80px;
  padding:12px;
  background:#fff;
  border-top:1px solid #e5e7eb;
  display:flex;
  gap:10px;
  align-items:center;
}
.chat-input-area .form-control { flex:1; min-width:0; height:52px; border-radius:10px; padding:12px; }
.chat-input-area .btn { width:52px; height:52px; border-radius:10px; display:flex; align-items:center; justify-content:center; }

/* small responsiveness */
@media (max-width:900px){
  .contacts-sidebar { width: 220px; }
  .sent { margin-left: 22%; }
  .received { margin-right: 22%; }
}
</style>

<div class="chat-container">

  <!-- SIDEBAR -->
  <div class="contacts-sidebar">
    <div class="p-3 border-bottom">
      <h5 class="m-0">Messages</h5>
    </div>

    {% if contacts %}
      {% for u in contacts %}
      <a href="{{ url_for('chat', receiver_id=u.id) }}" class="contact-item {% if active_contact and active_contact.id == u.id %}active{% endif %}">
        <div class="avatar">
          {% if u.profile_pic %}
            <img src="{{ u.profile_pic }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">
          {% else %}
            {{ u.username[0]|upper }}
          {% endif %}
        </div>
        <div style="min-width:0;">
          <div class="fw-bold" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;">{{ u.username }}</div>
          <div class="text-muted small">
            {% if u.last_message %}{{ u.last_message[:40] }}{% else %}{{ u.role|capitalize }}{% endif %}
          </div>
        </div>
        {% if u.unread_count and u.unread_count>0 %}
          <div style="margin-left:auto; color:#fff; background:#ef4444; padding:6px 8px; border-radius:999px; font-size:0.78rem;">
            {{ u.unread_count if u.unread_count<100 else '99+' }}
          </div>
        {% endif %}
      </a>
      {% endfor %}
    {% else %}
      <div class="p-4 text-center text-muted">
        <small>No contacts yet.</small>
      </div>
    {% endif %}
  </div>

  <!-- MAIN CHAT -->
  <div class="chat-area">
    {% if active_contact %}
      <!-- HEADER -->
      <div class="p-3 border-bottom d-flex align-items-center gap-3 bg-white" style="z-index:10;">
        <div class="avatar" style="border-radius:12px;">
          {% if active_contact.profile_pic %}
            <img src="{{ active_contact.profile_pic }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">
          {% else %}
            {{ active_contact.username[0]|upper }}
          {% endif %}
        </div>
        <div style="min-width:0;">
          <h6 class="m-0">{{ active_contact.username }}</h6>
          <div style="display:flex;align-items:center;gap:8px;">
            <small class="text-success">● Online</small>
            <span id="typingIndicator">Typing...</span>
          </div>
        </div>
      </div>

      <!-- MESSAGES -->
      <div class="messages-box" id="messagesBox" aria-live="polite" aria-relevant="additions">
        {% for msg in messages %}
          <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}"
               data-msg-id="{{ msg.id }}" data-ts="{{ msg.timestamp.isoformat() }}">
            <div class="msg-content">{{ msg.content|safe }}</div>
            <span class="msg-time" data-ts="{{ msg.timestamp.isoformat() }}">{{ msg.timestamp.strftime('%I:%M %p') }}</span>
          </div>
        {% endfor %}
      </div>

      <!-- INPUT -->
      <div class="chat-input-area" id="chatInputArea">
        <input id="messageInput" class="form-control" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn" class="btn btn-primary" aria-label="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>

    {% else %}
      <div class="d-flex justify-content-center align-items-center flex-column w-100 text-muted" style="flex:1;">
        <i class="far fa-comments fa-4x mb-3"></i>
        <h5>Select a conversation</h5>
      </div>
    {% endif %}
  </div>

</div>

<!-- SOCKET.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

{% if active_contact %}
<script>
(function(){
  // basic DOM refs
  const socket = io();
  const room = {{ room|tojson }};
  const receiverId = {{ active_contact.id }};
  const currentUserId = {{ current_user.id }};
  const messagesBox = document.getElementById('messagesBox');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  const inputArea = document.getElementById('chatInputArea');

  // --- Utility: friendly timestamp (Today / Yesterday / date + time)
  function parseISO(iso) {
    if(!iso) return null;
    const d = new Date(iso);
    if (isNaN(d)) return null;
    return d;
  }
  function friendlyTimestamp(iso) {
    const d = parseISO(iso);
    if(!d) return '';
    const now = new Date();
    const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const msgMid = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const diffDays = Math.round((todayMid - msgMid) / 86400000);
    const timeStr = d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    if (diffDays === 0) return `Today ${timeStr}`;
    if (diffDays === 1) return `Yesterday ${timeStr}`;
    return `${d.toLocaleDateString()} ${timeStr}`;
  }

  // format all rendered timestamps
  function formatAllTimestamps() {
    messagesBox.querySelectorAll('.msg-time').forEach(el => {
      const ts = el.getAttribute('data-ts') || el.dataset.ts;
      if (ts) el.innerText = friendlyTimestamp(ts);
    });
  }

  // set CSS var for input height so messages bottom padding adapts
  function setInputHeightVar(){
    const h = Math.max(inputArea.offsetHeight, 60);
    document.documentElement.style.setProperty('--input-height', `${h}px`);
  }
  setInputHeightVar();

  // auto-scroll to bottom
  function scrollToBottom() {
    if (!messagesBox) return;
    const prev = messagesBox.scrollTop + messagesBox.clientHeight;
    const nearBottom = (messagesBox.scrollHeight - prev) < 160;
    // if user is near bottom, auto-scroll; if they scrolled up intentionally, still scroll for new message from me
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  // Join socket room
  socket.on('connect', () => socket.emit('join', { room }));

  // ensure timestamps formatted and scrolled on load
  document.addEventListener('DOMContentLoaded', () => {
    formatAllTimestamps();
    // wait a tick for images to load then scroll
    setTimeout(scrollToBottom, 120);
  });
  // also run now (server-side render may be immediate)
  formatAllTimestamps();
  setTimeout(scrollToBottom, 120);

  // update input height on resize/focus (for mobile keyboard)
  window.addEventListener('resize', () => { setInputHeightVar(); setTimeout(scrollToBottom, 80); });
  input.addEventListener('focus', () => { setTimeout(() => { setInputHeightVar(); scrollToBottom(); }, 260); });

  // --- Sending message (optimistic UI with client_id)
  function generateClientId() {
    return 'c_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  }

  function appendLocalBubble(text, clientId) {
    const div = document.createElement('div');
    div.className = 'message sent';
    div.setAttribute('data-client-id', clientId);
    div.setAttribute('data-ts', new Date().toISOString());

    const content = document.createElement('div');
    content.className = 'msg-content';
    content.textContent = text;
    div.appendChild(content);

    const ts = document.createElement('span');
    ts.className = 'msg-time';
    ts.setAttribute('data-ts', new Date().toISOString());
    ts.innerText = friendlyTimestamp(new Date().toISOString());
    div.appendChild(ts);

    messagesBox.appendChild(div);
    scrollToBottom();
    return div;
  }

  sendBtn.addEventListener('click', onSend);
  input.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); onSend(); } });

  function onSend(){
    const text = input.value.trim();
    if (!text) return;
    const clientId = generateClientId();
    // optimistic UI
    appendLocalBubble(text, clientId);
    input.value = '';
    setInputHeightVar();

    socket.emit('send_message', {
      client_id: clientId,
      message: text,
      receiver_id: receiverId,
      room: room
    });
  }

  // --- Receive messages (also handles server echo for our own sent messages)
  socket.on('receive_message', (data) => {
    // if the server returned a client_id, replace the optimistic bubble
    if (data.client_id) {
      const temp = messagesBox.querySelector(`[data-client-id="${data.client_id}"]`);
      if (temp) {
        // create final bubble element
        const final = document.createElement('div');
        final.className = data.sender_id === currentUserId ? 'message sent' : 'message received';
        final.setAttribute('data-msg-id', data.id || '');
        final.setAttribute('data-ts', data.timestamp || '');

        const content = document.createElement('div');
        content.className = 'msg-content';
        // data.content may contain HTML; server used plain text — but preserve safe insertion
        content.textContent = data.content;
        final.appendChild(content);

        const ts = document.createElement('span');
        ts.className = 'msg-time';
        ts.setAttribute('data-ts', data.timestamp || new Date().toISOString());
        ts.innerText = friendlyTimestamp(data.timestamp || new Date().toISOString());
        final.appendChild(ts);

        temp.replaceWith(final);
        formatAllTimestamps();
        scrollToBottom();
        return;
      }
    }

    // otherwise just append normally
    const bubble = document.createElement('div');
    bubble.className = data.sender_id === currentUserId ? 'message sent' : 'message received';
    bubble.setAttribute('data-msg-id', data.id || '');
    bubble.setAttribute('data-ts', data.timestamp || '');

    const content = document.createElement('div');
    content.className = 'msg-content';
    content.textContent = data.content;
    bubble.appendChild(content);

    const ts = document.createElement('span');
    ts.className = 'msg-time';
    ts.setAttribute('data-ts', data.timestamp || new Date().toISOString());
    ts.innerText = friendlyTimestamp(data.timestamp || new Date().toISOString());
    bubble.appendChild(ts);

    messagesBox.appendChild(bubble);
    formatAllTimestamps();
    scrollToBottom();
  });

  // --- Typing indicator
  let typingTimeout = null;
  input.addEventListener('input', () => {
    socket.emit('typing', { room });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => socket.emit('stop_typing', { room }), 900);
  });

  socket.on('typing', (payload) => {
    if (payload.sender_id === receiverId) { typingIndicator.style.display = 'inline-block'; scrollToBottom(); }
  });
  socket.on('stop_typing', (payload) => {
    if (payload.sender_id === receiverId) typingIndicator.style.display = 'none';
  });

  // mark messages as read: optional - you already mark in backend when opening chat
  // but we can inform sender by emitting a status update if desired (not required)

})();
</script>
{% endif %}
{% endblock %}
